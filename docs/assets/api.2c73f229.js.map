{"version":3,"file":"api.2c73f229.js","sources":["../../src/lib/api.js"],"sourcesContent":["// Prefer Cloudflare Worker proxy if configured\nconst GAS_PROXY = import.meta.env.VITE_GAS_PROXY;\nconst GAS = GAS_PROXY || import.meta.env.VITE_GAS_URL;\nconst HEALTH = import.meta.env.VITE_HEALTH_URL || GAS_PROXY || import.meta.env.VITE_GAS_URL;\nconst FOLDER = import.meta.env.VITE_REPORTS_FOLDER_ID;\n\n// One-time runtime logging to verify endpoints in the deployed bundle\nif (typeof window !== 'undefined' && !window.__PF_ENDPOINTS_LOGGED__) {\n  window.__PF_ENDPOINTS_LOGGED__ = true;\n  // eslint-disable-next-line no-console\n  console.log('[PF] Endpoints:', {\n    GAS_PROXY: import.meta.env.VITE_GAS_PROXY || null,\n    GAS_RESOLVED: GAS,\n    HEALTH_RESOLVED: HEALTH,\n    QUEUE_URL: (typeof import.meta !== 'undefined' && import.meta.env && (import.meta.env.VITE_QUEUE_URL || null)),\n  });\n}\n\nasync function j(url, opt) { \n  const r = await fetch(url, {\n    ...opt,\n    credentials: 'omit',\n    headers: {\n      'Accept': 'application/json',\n      ...(opt?.headers || {})\n    }\n  }); \n  \n  const ctype = r.headers.get('content-type') || '';\n\n  if (!r.ok) {\n    const text = await r.text().catch(() => '');\n    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {\n      throw new Error(`Upstream returned HTML (${r.status}). Snippet: ${text.slice(0, 160)}`);\n    }\n    // Sometimes upstream sends JSON error with text/plain; try to parse\n    try {\n      if (text && (ctype.includes('json') || text.trim().startsWith('{') || text.trim().startsWith('['))) {\n        const parsed = JSON.parse(text);\n        throw new Error(`${r.status} ${r.statusText} — ${JSON.stringify(parsed).slice(0, 200)}`);\n      }\n    } catch {}\n    throw new Error(`${r.status} ${r.statusText} — ${text.slice(0, 200)}`);\n  }\n  \n  // Try JSON first\n  if (ctype.includes('json')) {\n    return await r.json();\n  }\n  // Fallback: parse text that looks like JSON (guards against wrong content-type)\n  const text = await r.text();\n  const trimmed = text.trim();\n  if (trimmed.startsWith('{') || trimmed.startsWith('[')) {\n    try { return JSON.parse(trimmed); } catch {}\n  }\n  // Surface a helpful error if still not JSON\n  throw new Error(`Failed to parse JSON response. Content-Type: ${ctype || 'n/a'}. Snippet: ${trimmed.slice(0, 200)}`);\n}\n\nexport async function withRetry(fn, tries = 3, delay = 600) {\n  let last;\n  for (let i = 0; i < tries; i++) { \n    try { \n      return await fn(); \n    } catch (e) { \n      last = e; \n      if (i < tries - 1) {\n        await new Promise(r => setTimeout(r, delay * (i + 1)));\n      }\n    }\n  }\n  throw last;\n}\n\nexport async function getHealth() { \n  if (!HEALTH) throw new Error('Missing VITE_HEALTH_URL/VITE_GAS_URL');\n  return withRetry(() => j(`${HEALTH}?fn=getHealth`));\n}\n\nexport async function getCadence() { \n  if (!GAS) throw new Error('Missing VITE_GAS_URL');\n  return withRetry(() => j(`${GAS}?fn=getCadence`));\n}\n\nexport async function setCadence(payload) {\n  if (!GAS) throw new Error('Missing VITE_GAS_URL');\n  return withRetry(() => j(\n    `${GAS}?fn=setCadence`, \n    { \n      method: 'POST', \n      headers: { 'Content-Type': 'application/json' }, \n      body: JSON.stringify(payload) \n    }\n  ));\n}\n\nexport async function getReports() { \n  if (!GAS || !FOLDER) throw new Error('Missing VITE_GAS_URL or VITE_REPORTS_FOLDER_ID');\n  return withRetry(() => j(`${GAS}?fn=getReports&folderId=${encodeURIComponent(FOLDER)}`));\n}\n\n// Backward compatibility\nexport async function gasGet(fn) {\n  return withRetry(() => j(`${GAS}?fn=${encodeURIComponent(fn)}`));\n}\n"],"names":["GAS_PROXY","GAS","HEALTH","FOLDER","j","url","opt","r","ctype","text","parsed","trimmed","withRetry","fn","tries","delay","last","i","e","getHealth","getCadence","setCadence","payload","getReports"],"mappings":"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"}